version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: lamla_postgres
    environment:
      POSTGRES_DB: lamla_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: julien-postgres.db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lamla_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django API Gateway
  django:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lamla_django
    command: >
      sh -c "python manage.py migrate &&
             python manage.py runserver 0.0.0.0:8000"
    environment:
      DATABASE_URL: postgresql://postgres:julien-postgres.db@localhost:5432/momo_chatbot_db
      FASTAPI_BASE_URL: http://fastapi:8001
      SECRET_KEY: django-insecure-change-in-production
      DEBUG: "True"
      ALLOWED_HOSTS: "localhost,127.0.0.1,django,0.0.0.0"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://react:3000,http://localhost:8000"
      CSRF_TRUSTED_ORIGINS: "http://localhost:3000,http://react:3000"
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - lamla-network

  # FastAPI Async Worker
  fastapi:
    build:
      context: ./backend
      dockerfile: Dockerfile.fastapi
    container_name: lamla_fastapi
    environment:
      FASTAPI_HOST: 0.0.0.0
      FASTAPI_PORT: 8001
      FASTAPI_WORKERS: 4
      FASTAPI_RELOAD: "false"
      FASTAPI_ALLOWED_ORIGINS: "http://localhost:3000,http://react:3000,http://localhost:8000,http://django:8000"
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      HUGGING_FACE_API_TOKEN: ${HUGGING_FACE_API_TOKEN:-}
    ports:
      - "8001:8001"
    depends_on:
      - django
    volumes:
      - ./backend:/app
    networks:
      - lamla-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # React Frontend
  react:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: lamla_react
    environment:
      REACT_APP_API_URL: http://localhost:8000
    ports:
      - "3000:3000"
    depends_on:
      - django
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    networks:
      - lamla-network

volumes:
  postgres_data:

networks:
  lamla-network:
    driver: bridge
